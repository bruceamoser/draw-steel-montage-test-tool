<form class="montage-test-sheet mts-form" autocomplete="off">

  {{!-- ═══════════════════════════════════════════════════════ HEADER ══ --}}
  <div class="mts-header">

    {{!-- Title row: name + push button --}}
    {{#if isGM}}
    <div class="mts-title-row">
      <input class="mts-name-input" name="name" type="text" value="{{item.name}}"
             placeholder="{{localize 'MONTAGE.Item.MontageTest'}}" />
      <button type="button" class="mts-push-btn" data-action="openForPlayers">
        <i class="fa-solid fa-share-from-square"></i> {{localize "MONTAGE.Sheet.OpenForPlayers"}}
      </button>
    </div>

    {{!-- Config row: difficulty + limits --}}
    <div class="mts-config-row">
      <label class="mts-label">{{localize "MONTAGE.Config.Difficulty"}}</label>
      <select class="mts-select" name="system.difficulty">
        {{#each difficulties}}
        <option value="{{this.value}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
        {{/each}}
      </select>

      <label class="mts-label">{{localize "MONTAGE.Config.SuccessLimit"}}</label>
      <input class="mts-number" type="number" name="system.successLimit"
             value="{{item.system.successLimit}}" min="1" />

      <label class="mts-label">{{localize "MONTAGE.Config.FailureLimit"}}</label>
      <input class="mts-number" type="number" name="system.failureLimit"
             value="{{item.system.failureLimit}}" min="1" />
    </div>
    {{else}}
    <div class="mts-title-row">
      <span class="mts-name-display">{{item.name}}</span>
    </div>
    {{/if}}

  </div>

  {{!-- ══════════════════════════════════════════════════════════ TABS ══ --}}
  <nav class="mts-tabs tabs" data-group="primary">
    <a class="mts-tab item" data-tab="basic">{{localize "MONTAGE.Sheet.Tab.Basic"}}</a>
    <a class="mts-tab item" data-tab="complications">{{localize "MONTAGE.Sheet.Tab.Complications"}}</a>
    {{#if isGM}}<a class="mts-tab item" data-tab="outcomes">{{localize "MONTAGE.Sheet.Tab.Outcomes"}}</a>{{/if}}
    <a class="mts-tab item" data-tab="results">{{localize "MONTAGE.Sheet.Tab.Results"}}</a>
  </nav>

  {{!-- ═══════════════════════════════════════════════ TAB CONTENT ══ --}}
  <div class="mts-tab-body tab-content">

    {{!-- ─────────────────────────────────────────── BASIC INFO ── --}}
    <div class="tab mts-tab-panel" data-group="primary" data-tab="basic">
      <div class="mts-field">
        <label class="mts-label">{{localize "MONTAGE.Sheet.Description"}}</label>
        {{#if isGM}}
        {{editor descriptionEnriched target="system.description" button=false owner=isOwner editable=true engine="prosemirror"}}
        {{else}}
        <div class="mts-prose-readonly">{{{descriptionEnriched}}}</div>
        {{/if}}
      </div>
    </div>

    {{!-- ──────────────────────────────────────── COMPLICATIONS ── --}}
    <div class="tab mts-tab-panel" data-group="primary" data-tab="complications">
      <div class="mts-complications-grid">

        {{!-- Round 1 --}}
        <section class="mts-comp-round">
          <h3 class="mts-section-heading">{{localize "MONTAGE.Config.Round1Complications"}}</h3>
          {{#if isGM}}
          <div class="mts-comp-list">
            {{#each complications.round1}}
            <div class="mts-comp-entry">
              {{editor this.textEnriched target=this.targetName button=false owner=../isOwner editable=true engine="prosemirror"}}
              <button type="button" class="mts-icon-btn mts-danger mts-comp-delete"
                      data-action="removeComplication" data-round="1" data-index="{{this.index}}">
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
            {{/each}}
          </div>
          <button type="button" class="mts-add-btn" data-action="addComplication" data-round="1">
            <i class="fa-solid fa-plus"></i> {{localize "MONTAGE.Config.AddComplication"}}
          </button>
          {{else}}
          <div class="mts-comp-readonly-list">
            {{#each complications.round1}}
            {{#if this.textEnriched}}<div class="mts-comp-readonly-item">{{{this.textEnriched}}}</div>{{/if}}
            {{/each}}
          </div>
          {{/if}}
        </section>

        {{!-- Round 2 --}}
        <section class="mts-comp-round">
          <h3 class="mts-section-heading">{{localize "MONTAGE.Config.Round2Complications"}}</h3>
          {{#if isGM}}
          <div class="mts-comp-list">
            {{#each complications.round2}}
            <div class="mts-comp-entry">
              {{editor this.textEnriched target=this.targetName button=false owner=../isOwner editable=true engine="prosemirror"}}
              <button type="button" class="mts-icon-btn mts-danger mts-comp-delete"
                      data-action="removeComplication" data-round="2" data-index="{{this.index}}">
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
            {{/each}}
          </div>
          <button type="button" class="mts-add-btn" data-action="addComplication" data-round="2">
            <i class="fa-solid fa-plus"></i> {{localize "MONTAGE.Config.AddComplication"}}
          </button>
          {{else}}
          <div class="mts-comp-readonly-list">
            {{#each complications.round2}}
            {{#if this.textEnriched}}<div class="mts-comp-readonly-item">{{{this.textEnriched}}}</div>{{/if}}
            {{/each}}
          </div>
          {{/if}}
        </section>

      </div>
    </div>

    {{!-- ───────────────────────────────────────────── OUTCOMES ── --}}
    {{#if isGM}}
    <div class="tab mts-tab-panel" data-group="primary" data-tab="outcomes">
      <p class="mts-hint">{{localize "MONTAGE.Sheet.OutcomesHint"}}</p>

      <div class="mts-field">
        <label class="mts-label mts-label-success">{{localize "MONTAGE.Outcome.TotalSuccess"}}</label>
        {{editor outcomesEnriched.totalSuccess target="system.outcomes.totalSuccess" button=false owner=isOwner editable=true engine="prosemirror"}}
      </div>
      <div class="mts-field">
        <label class="mts-label mts-label-partial">{{localize "MONTAGE.Outcome.PartialSuccess"}}</label>
        {{editor outcomesEnriched.partialSuccess target="system.outcomes.partialSuccess" button=false owner=isOwner editable=true engine="prosemirror"}}
      </div>
      <div class="mts-field">
        <label class="mts-label mts-label-failure">{{localize "MONTAGE.Outcome.TotalFailure"}}</label>
        {{editor outcomesEnriched.totalFailure target="system.outcomes.totalFailure" button=false owner=isOwner editable=true engine="prosemirror"}}
      </div>

      {{#if tally.outcomeKey}}
      <div class="mts-outcome-banner mts-outcome-{{tally.outcomeKey}}">{{tally.outcomeLabel}}</div>
      {{/if}}
    </div>
    {{/if}}

    {{!-- ─────────────────────────────────────────────── RESULTS ── --}}
    <div class="tab mts-tab-panel" data-group="primary" data-tab="results">

      <div class="mts-tally-bar">
        <span class="mts-tally-chip mts-chip-success">
          {{localize "MONTAGE.Tracker.Successes"}}: {{tally.successes}} / {{item.system.successLimit}}
        </span>
        <span class="mts-tally-chip mts-chip-failure">
          {{localize "MONTAGE.Tracker.Failures"}}: {{tally.failures}} / {{item.system.failureLimit}}
        </span>
        {{#if tally.outcomeKey}}
        <span class="mts-tally-chip mts-chip-outcome">{{tally.outcomeLabel}}</span>
        {{/if}}
      </div>

      {{#if isGM}}
      <div class="mts-participants-header">
        <span class="mts-section-heading">{{localize "MONTAGE.Sheet.Participants"}}</span>
        <button type="button" class="mts-add-btn" data-action="addParticipant">
          <i class="fa-solid fa-plus"></i> {{localize "MONTAGE.Sheet.AddParticipant"}}
        </button>
      </div>
      <div class="mts-drop-zone montage-participants-drop">
        <i class="fa-solid fa-user-plus"></i> {{localize "MONTAGE.Sheet.DropActor"}}
      </div>
      {{else}}
      <p class="mts-hint">{{localize "MONTAGE.Sheet.ResultsNote"}}</p>
      {{/if}}

      {{#if participants.length}}
      <table class="mts-results-table">
        <thead>
          <tr>
            <th>{{localize "MONTAGE.Sheet.Hero"}}</th>
            <th>{{localize "MONTAGE.Tracker.Round"}} 1</th>
            <th>{{localize "MONTAGE.Tracker.Round"}} 2</th>
            {{#if isGM}}<th></th>{{/if}}
          </tr>
        </thead>
        <tbody>
          {{#each participants}}
          <tr>
            <td class="mts-hero-cell">
              <img class="mts-hero-thumb" src="{{this.img}}" />
              {{#if ../isGM}}
              <input type="hidden" name="system.participants.{{this.index}}.actorUuid" value="{{this.actorUuid}}" />
              <input type="hidden" name="system.participants.{{this.index}}.img" value="{{this.img}}" />
              <input class="mts-text-input" type="text"
                     name="system.participants.{{this.index}}.name"
                     value="{{this.name}}"
                     placeholder="{{localize 'MONTAGE.Sheet.HeroName'}}" />
              {{else}}
              <span class="mts-hero-name">{{this.name}}</span>
              {{/if}}
            </td>
            <td>
              {{#if ../isGM}}
              <select class="mts-select" name="system.participants.{{this.index}}.round1">
                {{#each ../resultChoices}}
                <option value="{{this.value}}" {{#if (eq this.value ../round1)}}selected{{/if}}>{{this.label}}</option>
                {{/each}}
              </select>
              {{else}}
              <span class="mts-result-chip mts-result-{{this.round1}}">{{this.round1}}</span>
              {{/if}}
            </td>
            <td>
              {{#if ../isGM}}
              <select class="mts-select" name="system.participants.{{this.index}}.round2">
                {{#each ../resultChoices}}
                <option value="{{this.value}}" {{#if (eq this.value ../round2)}}selected{{/if}}>{{this.label}}</option>
                {{/each}}
              </select>
              {{else}}
              <span class="mts-result-chip mts-result-{{this.round2}}">{{this.round2}}</span>
              {{/if}}
            </td>
            {{#if ../isGM}}
            <td class="mts-actions-cell">
              <button type="button" class="mts-icon-btn mts-danger"
                      data-action="removeParticipant" data-index="{{this.index}}">
                <i class="fa-solid fa-trash"></i>
              </button>
            </td>
            {{/if}}
          </tr>
          {{/each}}
        </tbody>
      </table>
      {{else}}
      <p class="mts-hint mts-hint-center">{{localize "MONTAGE.Sheet.NoParticipants"}}</p>
      {{/if}}

    </div>{{!-- /results --}}

  </div>{{!-- /mts-tab-body --}}
</form>
