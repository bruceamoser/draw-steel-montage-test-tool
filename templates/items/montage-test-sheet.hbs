<form class="montage-test-sheet" autocomplete="off">
  <header class="sheet-header flexrow">
    <div class="header-fields">
      <h1 class="charname">
        <input name="name" type="text" value="{{item.name}}" placeholder="{{localize 'MONTAGE.Item.MontageTest'}}" />
      </h1>

      {{#if isGM}}
      <div class="montage-basic-row">
        <label>{{localize "MONTAGE.Config.Difficulty"}}</label>
        <select name="system.difficulty">
          {{#each difficulties}}
          <option value="{{this.value}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
          {{/each}}
        </select>

        <label>{{localize "MONTAGE.Config.SuccessLimit"}}</label>
        <input type="number" name="system.successLimit" value="{{item.system.successLimit}}" min="1" />

        <label>{{localize "MONTAGE.Config.FailureLimit"}}</label>
        <input type="number" name="system.failureLimit" value="{{item.system.failureLimit}}" min="1" />

        <button type="button" class="montage-btn-primary montage-push-btn" data-action="openForPlayers">
          <i class="fa-solid fa-share-from-square"></i> {{localize "MONTAGE.Sheet.OpenForPlayers"}}
        </button>
      </div>
      {{/if}}
    </div>
  </header>

  <nav class="sheet-tabs tabs" data-group="primary">
    <a class="item" data-tab="basic">{{localize "MONTAGE.Sheet.Tab.Basic"}}</a>
    <a class="item" data-tab="complications">{{localize "MONTAGE.Sheet.Tab.Complications"}}</a>
    {{#if isGM}}<a class="item" data-tab="outcomes">{{localize "MONTAGE.Sheet.Tab.Outcomes"}}</a>{{/if}}
    <a class="item" data-tab="results">{{localize "MONTAGE.Sheet.Tab.Results"}}</a>
  </nav>

  <section class="tab-content">

    {{!-- BASIC --}}
    <div class="tab" data-group="primary" data-tab="basic">
      <div class="form-group stacked">
        <label>{{localize "MONTAGE.Sheet.Description"}}</label>
        {{editor descriptionEnriched target="system.description" button=false owner=isOwner editable=isGM}}
      </div>
    </div>

    {{!-- COMPLICATIONS --}}
    <div class="tab" data-group="primary" data-tab="complications">
      <div class="montage-complications">
        <section class="montage-complications-round">
          <h3>{{localize "MONTAGE.Config.Round1Complications"}}</h3>
          {{#if isGM}}
          <div class="montage-complication-list">
            {{#each complications.round1}}
            <div class="montage-complication-entry">
              {{editor textEnriched target=targetName button=false owner=../isOwner editable=true}}
              <button type="button" class="montage-btn-danger" data-action="removeComplication" data-round="1" data-index="{{this.index}}">
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
            {{/each}}
          </div>
          <button type="button" class="montage-btn-primary" data-action="addComplication" data-round="1">
            <i class="fa-solid fa-plus"></i> {{localize "MONTAGE.Config.AddComplication"}}
          </button>
          {{else}}
          <ul class="montage-readonly-list">
            {{#each complications.round1}}
            {{#if this.text}}<li>{{{this.text}}}</li>{{/if}}
            {{/each}}
          </ul>
          {{/if}}
        </section>

        <section class="montage-complications-round">
          <h3>{{localize "MONTAGE.Config.Round2Complications"}}</h3>
          {{#if isGM}}
          <div class="montage-complication-list">
            {{#each complications.round2}}
            <div class="montage-complication-entry">
              {{editor textEnriched target=targetName button=false owner=../isOwner editable=true}}
              <button type="button" class="montage-btn-danger" data-action="removeComplication" data-round="2" data-index="{{this.index}}">
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
            {{/each}}
          </div>
          <button type="button" class="montage-btn-primary" data-action="addComplication" data-round="2">
            <i class="fa-solid fa-plus"></i> {{localize "MONTAGE.Config.AddComplication"}}
          </button>
          {{else}}
          <ul class="montage-readonly-list">
            {{#each complications.round2}}
            {{#if this.text}}<li>{{{this.text}}}</li>{{/if}}
            {{/each}}
          </ul>
          {{/if}}
        </section>
      </div>
    </div>

    {{!-- OUTCOMES (GM only) --}}
    {{#if isGM}}
    <div class="tab" data-group="primary" data-tab="outcomes">
      <p class="notes">{{localize "MONTAGE.Sheet.OutcomesHint"}}</p>

      <div class="form-group stacked">
        <label>{{localize "MONTAGE.Outcome.TotalSuccess"}}</label>
        {{editor outcomesEnriched.totalSuccess target="system.outcomes.totalSuccess" button=false owner=isOwner editable=true}}
      </div>

      <div class="form-group stacked">
        <label>{{localize "MONTAGE.Outcome.PartialSuccess"}}</label>
        {{editor outcomesEnriched.partialSuccess target="system.outcomes.partialSuccess" button=false owner=isOwner editable=true}}
      </div>

      <div class="form-group stacked">
        <label>{{localize "MONTAGE.Outcome.TotalFailure"}}</label>
        {{editor outcomesEnriched.totalFailure target="system.outcomes.totalFailure" button=false owner=isOwner editable=true}}
      </div>

      {{#if tally.outcomeKey}}
      <hr />
      <div class="montage-outcome montage-outcome-{{tally.outcomeKey}}">
        <h3>{{tally.outcomeLabel}}</h3>
      </div>
      {{/if}}
    </div>
    {{/if}}

    {{!-- RESULTS (all users; players see read-only view) --}}
    <div class="tab" data-group="primary" data-tab="results">
      <div class="montage-results-header">
        <div class="montage-results-tally">
          <span class="montage-badge montage-status-active">{{localize "MONTAGE.Tracker.Successes"}}: {{tally.successes}}</span>
          <span class="montage-badge montage-status-active">{{localize "MONTAGE.Tracker.Failures"}}: {{tally.failures}}</span>
          {{#if tally.outcomeKey}}
          <span class="montage-badge montage-status-resolved">{{tally.outcomeLabel}}</span>
          {{/if}}
        </div>

        <div class="montage-results-limits">
          <span class="notes">{{localize "MONTAGE.Config.SuccessLimit"}}: {{item.system.successLimit}}</span>
          <span class="notes">{{localize "MONTAGE.Config.FailureLimit"}}: {{item.system.failureLimit}}</span>
        </div>
      </div>

      <section class="montage-participants">
        {{#if isGM}}
        <header class="flexrow montage-participants-header">
          <h3>{{localize "MONTAGE.Sheet.Participants"}}</h3>
          <button type="button" data-action="addParticipant" class="montage-btn-primary">
            <i class="fa-solid fa-plus"></i> {{localize "MONTAGE.Sheet.AddParticipant"}}
          </button>
        </header>
        <div class="notes montage-participants-drop">{{localize "MONTAGE.Sheet.DropActor"}}</div>
        {{else}}
        <h3>{{localize "MONTAGE.Sheet.Participants"}}</h3>
        <p class="notes">{{localize "MONTAGE.Sheet.ResultsNote"}}</p>
        {{/if}}

        {{#if participants.length}}
        <table class="montage-results-table">
          <thead>
            <tr>
              <th>{{localize "MONTAGE.Sheet.Hero"}}</th>
              <th>{{localize "MONTAGE.Tracker.Round"}} 1</th>
              <th>{{localize "MONTAGE.Tracker.Round"}} 2</th>
              {{#if isGM}}<th></th>{{/if}}
            </tr>
          </thead>
          <tbody>
            {{#each participants}}
            <tr>
              <td class="montage-hero-cell">
                <img src="{{this.img}}" class="montage-hero-thumb" />
                {{#if ../isGM}}
                <input type="hidden" name="system.participants.{{this.index}}.actorUuid" value="{{this.actorUuid}}" />
                <input type="text" name="system.participants.{{this.index}}.name" value="{{this.name}}" placeholder="{{localize 'MONTAGE.Sheet.HeroName'}}" />
                <input type="hidden" name="system.participants.{{this.index}}.img" value="{{this.img}}" />
                {{else}}
                <span>{{this.name}}</span>
                {{/if}}
              </td>

              <td>
                {{#if ../isGM}}
                <select name="system.participants.{{this.index}}.round1">
                  {{#each ../../resultChoices}}
                  <option value="{{this.value}}" {{#if (eq this.value ../this.round1)}}selected{{/if}}>{{this.label}}</option>
                  {{/each}}
                </select>
                {{else}}
                <span class="montage-result-badge montage-result-{{this.round1}}">{{this.round1}}</span>
                {{/if}}
              </td>

              <td>
                {{#if ../isGM}}
                <select name="system.participants.{{this.index}}.round2">
                  {{#each ../../resultChoices}}
                  <option value="{{this.value}}" {{#if (eq this.value ../this.round2)}}selected{{/if}}>{{this.label}}</option>
                  {{/each}}
                </select>
                {{else}}
                <span class="montage-result-badge montage-result-{{this.round2}}">{{this.round2}}</span>
                {{/if}}
              </td>

              {{#if ../isGM}}
              <td class="montage-row-actions">
                <button type="button" data-action="removeParticipant" data-index="{{this.index}}" class="montage-btn-danger">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </td>
              {{/if}}
            </tr>
            {{/each}}
          </tbody>
        </table>
        {{else}}
        <p class="notes">{{localize "MONTAGE.Sheet.NoParticipants"}}</p>
        {{/if}}
      </section>
    </div>

  </section>
</form>
